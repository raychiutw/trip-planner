<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="2026 Ê≤ñÁπ©‰∫îÊó•Ëá™ÈßïÈÅäÂÆåÊï¥Ë°åÁ®ãË°®ÔºöÈÇ£Èú∏„ÄÅÂåóË∞∑ÁæéÂúãÊùë„ÄÅÈùí‰πãÊ¥ûÁ™ü„ÄÅÁæéÈ∫óÊµ∑Ê∞¥ÊóèÈ§®„ÄÅÂè§ÂÆáÂà©Â≥∂„ÄÇÂê´È§êÂª≥Êé®Ëñ¶„ÄÅÂú∞ÂúñÂ∞éËà™„ÄÅÈ†êÁÆóË¶èÂäÉ„ÄÇ">
    <meta name="theme-color" content="#0077B6">
    <meta property="og:title" content="2026 Ê≤ñÁπ©‰∫îÊó•Ëá™ÈßïÈÅäË°åÁ®ãË°®">
    <meta property="og:description" content="ÈÇ£Èú∏‚ÜíÂåóË∞∑ÁæéÂúãÊùë‚ÜíÈùí‰πãÊ¥ûÁ™ü‚ÜíÁæéÈ∫óÊµ∑Ê∞¥ÊóèÈ§®‚ÜíÂè§ÂÆáÂà©Â≥∂Ôºå‰∫îÊó•ÂÆåÊï¥Ë°åÁ®ãÂê´È§êÂª≥‰∏âÈÅ∏‰∏Ä„ÄÅÂú∞ÂúñÂ∞éËà™„ÄÅÈ†êÁÆóË¶èÂäÉ">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://raychiutw.github.io/okinawa-trip-2026/">
    <title>2026 Ê≤ñÁπ©‰∫îÊó•Ëá™ÈßïÈÅäË°åÁ®ãË°®</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://api.open-meteo.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --blue: #0077B6;
            --blue-light: #E0F4FF;
            --sand: #C4956A;
            --sand-light: #F5EDE0;
            --white: #FFFFFF;
            --gray: #666666;
            --gray-light: #F5F5F5;
            --text: #1A3A5C;
            --fs-lg: 1.15rem;
            --fs-md: 0.95rem;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body { font-family: 'Noto Sans TC', sans-serif; background: var(--gray-light); font-size: var(--fs-md); color: var(--text); line-height: 1.6; }

        .container { max-width: 800px; margin: 0 auto; }


        /* ===== Menu Dropdown (two-column) ===== */
        .menu-dropdown { display: none; position: fixed; background: var(--white); border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.18); padding: 6px; z-index: 300; }
        .menu-dropdown.open { display: block; }
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0 4px; }
        .menu-col { min-width: 160px; }
        .menu-item { display: block; width: 100%; padding: 10px 14px; border: none; background: none; border-radius: 8px; cursor: pointer; font-size: var(--fs-lg); font-family: inherit; color: var(--text); text-align: left; white-space: nowrap; }
        .menu-item:hover { background: var(--blue-light); }

        .ov-card p { font-size: var(--fs-md); margin: 4px 0; line-height: 1.7; }
        .ov-card a { color: var(--blue); font-weight: 600; text-decoration: none; }
        .ov-card a:hover { text-decoration: underline; }
        .ov-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 12px; }
        .ov-card { padding: 14px; border-radius: 12px; }
        .ov-card h4 { margin-top: 0; }
        .flight-row { display: flex; align-items: center; padding: 10px 12px; background: var(--blue-light); border-radius: 12px; margin-bottom: 8px; gap: 8px; }
        .flight-row .flight-icon { font-size: 1.4rem; flex-shrink: 0; }
        .flight-info { display: flex; flex-wrap: wrap; align-items: baseline; gap: 4px 10px; flex: 1; min-width: 0; }
        .flight-label { font-weight: 700; font-size: var(--fs-md); white-space: nowrap; }
        .flight-route { font-weight: 600; font-size: var(--fs-lg); white-space: nowrap; }
        .flight-time { font-size: var(--fs-md); color: var(--gray); white-space: nowrap; }
        .weather-list { list-style: none; padding: 0; }
        .weather-list li { font-size: var(--fs-md); padding: 3px 0 3px 22px; position: relative; }
        .weather-list li::before { content: 'üåä'; position: absolute; left: 0; }

        /* ===== Sticky Nav ===== */
        .sticky-nav { position: sticky; top: 0; z-index: 200; background: var(--blue); color: var(--white); padding: 8px 12px; display: flex; align-items: center; gap: 8px; }
        body.dark .sticky-nav { background: #1565C0; }

        /* ===== Day Header (section divider) ===== */
        .day-header { position: relative; z-index: 100; background: var(--blue); color: var(--white); padding: 8px 12px; display: flex; align-items: center; gap: 8px; scroll-margin-top: 44px; }
        .day-header h2 { font-size: var(--fs-lg); font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .day-header .dh-right { font-size: var(--fs-md); opacity: 0.9; white-space: nowrap; margin-left: auto; }
        .dh-nav { display: flex; gap: 3px; flex-shrink: 0; }
        .dn { background: rgba(255,255,255,0.2); color: var(--white); border: none; padding: 3px 8px; border-radius: 12px; font-size: var(--fs-lg); font-family: inherit; cursor: pointer; font-weight: 600; }
        .dn:hover { background: rgba(255,255,255,0.35); }
        .dn.active { background: var(--white); color: var(--blue); }
        .dh-menu { background: rgba(255,255,255,0.2); color: var(--white); border: none; width: 32px; height: 32px; border-radius: 8px; font-size: var(--fs-lg); cursor: pointer; font-weight: 700; flex-shrink: 0; margin-left: auto; }
        .dh-menu:hover { background: rgba(255,255,255,0.35); }
        .day-header .dh-right + .dh-menu { margin-left: 0; }

        /* ===== Day Content ===== */
        .day-content { background: var(--white); padding: 0 20px 16px; }

        /* ===== Hourly Weather ===== */
        .hourly-weather { padding: 12px 0; overflow: hidden; }
        .hourly-weather-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .hourly-weather-title { font-size: var(--fs-md); font-weight: 600; color: var(--gray); }
        .hw-update-time { font-size: var(--fs-md); color: var(--gray); opacity: 0.7; }
        .hw-grid { display: flex; gap: 6px; overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: thin; padding-bottom: 4px; scroll-behavior: smooth; }
        .hw-block { background: var(--white); border-radius: 10px; padding: 8px 6px; text-align: center; border: 1px solid var(--gray-light); min-width: calc((100% - 42px) / 8); flex-shrink: 0; }
        .hw-block.hw-now { border: 2px solid var(--blue); background: var(--blue-light); }
        .hw-block-time { font-size: var(--fs-md); font-weight: 600; color: var(--gray); margin-bottom: 2px; }
        .hw-block-loc { font-size: var(--fs-md); color: var(--white); border-radius: 4px; padding: 1px 5px; display: inline-block; margin-bottom: 2px; white-space: nowrap; }
        .hw-loc-0 { background: var(--blue); }
        .hw-loc-1 { background: var(--sand); }
        .hw-loc-2 { background: var(--text); }
        .hw-loc-3 { background: var(--gray); }
        .hw-block-icon { font-size: 1.4rem; line-height: 1.3; }
        .hw-block-temp { font-size: var(--fs-md); font-weight: 700; color: var(--text); }
        .hw-block-rain { font-size: var(--fs-md); color: var(--blue); }
        .hw-block-rain.hw-rain-high { color: var(--text); font-weight: 700; }
        .hw-loading { text-align: center; padding: 10px; color: var(--gray); font-size: var(--fs-md); }
        .hw-error { text-align: center; padding: 10px; color: var(--text); font-size: var(--fs-md); background: var(--blue-light); border-radius: 8px; }

        /* ===== Collapsible Row (Hotel / Budget) ===== */
        .col-row { display: flex; align-items: center; gap: 8px; padding: 10px 0; cursor: pointer; border-bottom: 1px solid var(--gray-light); user-select: none; }
        .col-row:hover { color: var(--blue); }
        .col-row .arrow { margin-left: auto; color: var(--gray); transition: transform 0.2s; font-size: var(--fs-md); }
        .col-row.open .arrow { transform: rotate(90deg); }
        .col-detail { display: none; padding: 10px 0; font-size: var(--fs-md); line-height: 1.7; }
        .col-detail.open { display: block; }
        .col-detail a { color: var(--blue); font-weight: 600; text-decoration: none; }
        .col-detail a:hover { text-decoration: underline; }
        .status-tag { font-size: var(--fs-md); padding: 2px 8px; border-radius: 8px; font-weight: 600; }
        .status-tag.pending { background: var(--sand-light); color: var(--sand); }
        .status-tag.paid { background: var(--blue-light); color: var(--blue); }
        .hotel-detail-grid { display: flex; flex-wrap: wrap; gap: 6px 16px; margin-bottom: 8px; }
        .hotel-sub { margin-top: 8px; padding: 8px 10px; background: var(--blue-light); border-radius: 8px; }

        /* ===== Timeline ===== */
        .timeline { position: relative; padding-left: 18px; margin: 8px 0 0 10px; border-left: 2px solid var(--blue-light); }

        /* ===== Timeline Event ===== */
        .tl-event { position: relative; padding: 6px 0; }
        .tl-event::before { content: ''; position: absolute; left: -24px; top: 15px; width: 10px; height: 10px; border-radius: 50%; background: var(--blue); border: 2px solid var(--white); z-index: 1; }
        .tl-head { display: flex; align-items: baseline; gap: 8px; padding: 4px 8px; border-radius: 8px; }
        .tl-head.clickable { cursor: pointer; }
        .tl-head.clickable:hover { background: var(--blue-light); }
        .tl-time { font-weight: 700; font-size: var(--fs-md); color: var(--blue); min-width: 95px; flex-shrink: 0; }
        .tl-title { font-weight: 600; font-size: var(--fs-lg); }
        .tl-title a { color: var(--text); text-decoration: none; }
        .tl-title a:hover { color: var(--blue); text-decoration: underline; }
        .tl-arrow { margin-left: auto; color: var(--gray); font-size: var(--fs-md); transition: transform 0.2s; flex-shrink: 0; }
        .tl-event.expanded .tl-arrow { transform: rotate(90deg); }
        .tl-body { display: none; padding: 4px 8px 8px; font-size: var(--fs-md); line-height: 1.7; }
        .tl-event.expanded .tl-body { display: block; }
        .tl-desc { color: var(--gray); margin-bottom: 6px; }
        .tl-transit { padding: 1px 8px 1px 0; margin-left: 0; font-size: var(--fs-md); color: var(--gray); }

        /* ===== Nav Group (Map Links) ===== */
        .nav-links { margin: 6px 0; }
        .map-link { display: inline-flex; align-items: center; gap: 3px; background: none; color: var(--blue); border: 1.5px solid var(--blue); padding: 3px 8px; border-radius: 6px; font-size: var(--fs-md); text-decoration: none; margin-right: 4px; margin-bottom: 3px; height: 28px; vertical-align: middle; }
        .map-link:hover { background: var(--blue); color: var(--white); }
        .map-link .g-icon { display: inline-flex; align-items: center; justify-content: center; width: 16px; height: 16px; border-radius: 50%; background: #4285F4; color: #fff; font-size: 10px; font-weight: 700; font-family: 'Google Sans', Arial, sans-serif; line-height: 1; flex-shrink: 0; }
        .map-link.apple { color: #333; border-color: #333; background: none; }
        .map-link.apple:hover { background: #333; color: var(--white); }
        .map-link.apple:hover .apple-icon svg { fill: #fff; }
        .map-link .apple-icon { display: inline-flex; align-items: center; width: 14px; height: 14px; flex-shrink: 0; }
        .map-link .apple-icon svg { width: 14px; height: 14px; fill: #333; }
        .map-link.mapcode { color: var(--sand); border-color: var(--sand); background: none; }
        .map-link.mapcode:hover { background: var(--sand); color: var(--white); }
        .map-link-inline { font-size: var(--fs-md); padding: 1px 6px; height: 22px; }
        .map-link-inline .g-icon { width: 13px; height: 13px; font-size: 8px; }
        .map-link-inline .apple-icon, .map-link-inline .apple-icon svg { width: 11px; height: 11px; }

        /* ===== Info Boxes ===== */
        .info-box { margin: 6px 0; padding: 8px 12px; border-radius: 8px; font-size: var(--fs-md); line-height: 1.7; }
        .info-box a { color: var(--blue); font-weight: 600; text-decoration: none; }
        .info-box a:hover { text-decoration: underline; }
        .info-box strong { font-weight: 600; }
        .restaurant-choice { padding: 6px 0; border-bottom: 1px dashed var(--sand); line-height: 1.7; }
        .restaurant-choice:last-child { border-bottom: none; }
        .restaurant-choice strong { color: var(--sand); }
        .restaurant-choice a:not(.map-link) { color: var(--blue); font-weight: 600; text-decoration: none; }
        .restaurant-choice a:not(.map-link):hover { text-decoration: underline; }
        .restaurant-meta { display: block; margin-top: 3px; font-size: var(--fs-md); color: var(--gray); }
        .restaurant-meta a { color: var(--blue); font-weight: 600; text-decoration: none; }

        /* ===== Budget ===== */
        .budget-table { width: 100%; border-collapse: collapse; font-size: var(--fs-md); }
        .budget-table td { padding: 3px 0; }
        .budget-table td:last-child { text-align: right; font-weight: 600; color: var(--blue); }
        .budget-total { border-top: 2px solid var(--sand); margin-top: 6px; padding-top: 6px; font-weight: 700; color: var(--blue); }
        .notes-list { list-style: none; padding: 0; margin-top: 8px; }
        .notes-list li { padding: 2px 0 2px 22px; position: relative; font-size: var(--fs-md); }
        .notes-list li::before { content: 'üìå'; position: absolute; left: 0; }

        /* ===== Footer ===== */
        footer { text-align: center; padding: 24px 20px; background: var(--white); color: var(--text); border-top: 2px solid var(--blue-light); margin-top: 4px; }
        footer h3 { font-size: var(--fs-lg); color: var(--blue); }
        footer p { font-size: var(--fs-md); margin-top: 4px; }

        /* ===== Print Mode ===== */
        .print-mode { --blue: #0077B6; --blue-light: #E0F4FF; --sand: #C4956A; --sand-light: #F5EDE0; --white: #FFFFFF; --gray: #666666; --gray-light: #F5F5F5; --text: #1A3A5C; background: var(--gray-light) !important; }
        .print-mode .container { max-width: 420px; margin: 0 auto; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        .print-mode .tl-body, .print-mode .col-detail { display: block !important; }
        .print-mode .tl-arrow, .print-mode .col-row .arrow { display: none !important; }
        .print-mode .dh-nav, .print-mode .dh-menu { display: none !important; }
        .print-mode .sticky-nav { display: none; }
        .print-mode .top-bar, .print-mode .day-header { position: relative !important; }
        .print-mode .day-header { flex-wrap: wrap; padding: 8px 12px; background: var(--blue) !important; }
        .print-mode .hourly-weather { display: none !important; }
        .print-mode .map-link { color: #333 !important; border-color: #333 !important; background: none !important; }
        .print-mode .status-tag { background: #ddd !important; color: #333 !important; }
        .print-mode .ov-grid { grid-template-columns: 1fr; }
        .print-exit-btn { display: none; position: fixed; top: 10px; left: 50%; transform: translateX(-50%); z-index: 9999; background: #D32F2F; color: #fff; border: none; padding: 10px 24px; border-radius: 8px; font-size: var(--fs-md); font-family: inherit; cursor: pointer; font-weight: 600; box-shadow: 0 2px 12px rgba(0,0,0,0.3); }
        .print-exit-btn:hover { background: #B71C1C; }
        .print-mode .print-exit-btn { display: block; }
        @media print {
            @page { size: A4; margin: 12mm; }
            body { --blue: #0077B6; --blue-light: #E0F4FF; --sand: #C4956A; --sand-light: #F5EDE0; --white: #FFFFFF; --gray: #666666; --gray-light: #F5F5F5; --text: #1A3A5C; background: #fff !important; }
            .sticky-nav, .menu-dropdown, .dh-nav, .dh-menu, .print-exit-btn, .hourly-weather { display: none !important; }
            .container { max-width: 100% !important; box-shadow: none !important; }
            .tl-body, .col-detail { display: block !important; }
            .tl-arrow, .col-row .arrow { display: none !important; }
            .top-bar, .day-header { position: relative !important; }
            .day-header { background: var(--blue) !important; }
            .day-content { break-inside: avoid; }
        }

        /* ===== Mobile ===== */
        @media (max-width: 600px) {
            :root { --fs-lg: 1.25rem; --fs-md: 1.05rem; }
            .day-header { top: 0; padding: 6px 8px; gap: 4px; flex-wrap: wrap; }
            .dh-nav { gap: 2px; }
            .tl-head { flex-wrap: wrap; }
            .tl-time { min-width: 75px; }
            .hw-grid { gap: 5px; scroll-snap-type: x mandatory; }
            .hw-block { min-width: calc((100% - 10px) / 3); scroll-snap-align: start; }
        }

        /* ===== Weather Collapsible ===== */
        .hw-summary { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; cursor: pointer; font-size: var(--fs-md); color: var(--gray); user-select: none; }
        .hw-summary:hover { color: var(--blue); }
        .hw-summary-arrow { transition: transform 0.2s; margin-left: 8px; flex-shrink: 0; }
        .hw-open .hw-summary-arrow { transform: rotate(90deg); }
        .hw-detail { display: none; }
        .hw-open .hw-detail { display: block; }

        /* ===== Info Header ===== */
        .info-header { background: var(--text) !important; }


        /* ===== Menu Separator ===== */
        .menu-sep { border-top: 1px solid var(--gray-light); margin: 4px 0; }

        /* ===== Dark Mode ===== */
        body.dark { --blue: #4FC3F7; --blue-light: #1A2A3A; --sand: #E0A870; --sand-light: #2A2218; --white: #1E1E1E; --gray: #AAAAAA; --gray-light: #2A2A2A; --text: #E8E8E8; background: #121212; }
        body.dark .sticky-nav { background: #1565C0; color: #E8E8E8; }
        body.dark .day-header { background: #1565C0; color: #E8E8E8; }
        body.dark .info-header { background: #333 !important; color: #E8E8E8 !important; }
        body.dark .dn { color: #E8E8E8; }
        body.dark .dn.active { background: #E8E8E8; color: #1565C0; }
        body.dark .dh-menu { background: rgba(255,255,255,0.15); color: #E8E8E8; }
        body.dark .map-link { color: #4FC3F7; border-color: #4FC3F7; }
        body.dark .map-link:hover { background: #1565C0; color: #fff; border-color: #1565C0; }
        body.dark .map-link.apple { color: #aaa; border-color: #aaa; }
        body.dark .map-link.apple .apple-icon svg { fill: #aaa; }
        body.dark .map-link.apple:hover { background: #555; color: #fff; border-color: #555; }
        body.dark .map-link.apple:hover .apple-icon svg { fill: #fff; }
        body.dark .map-link.mapcode { color: var(--sand); border-color: var(--sand); }
        body.dark .map-link.mapcode:hover { background: var(--sand); color: #1E1E1E; }
        body.dark .hw-block { border-color: #333; }
        body.dark .menu-dropdown { background: #2A2A2A; box-shadow: 0 8px 32px rgba(0,0,0,0.4); }
        body.dark .flight-row { background: #1A2A3A; }
        body.dark .info-box.reservation { background: #2A2218; }
        body.dark .info-box.parking { background: #1A2A3A; }
        body.dark .info-box.souvenir { background: #1A2A3A; }
        body.dark .info-box.restaurants { background: #2A2218; }
        body.dark .hotel-sub { background: #1A2A3A; }
        body.dark .col-row { border-bottom-color: #333; }
        body.dark .restaurant-choice { border-bottom-color: #444; }
        body.dark .menu-sep { border-top-color: #444; }
        body.dark footer { border-top-color: #333; }

    </style>
</head>
<body>
    <div class="container">

        <!-- ===== Sticky Nav ===== -->
        <div class="sticky-nav" id="stickyNav">
            <div class="dh-nav" id="navPills"></div>
            <button class="dh-menu" onclick="toggleMenu(event)">‚â°</button>
        </div>

        <!-- ===== Dynamic Trip Content ===== -->
        <div id="tripContent"><div style="text-align:center;padding:40px;color:var(--gray);">‚è≥ ËºâÂÖ•Ë°åÁ®ãË≥áÊñô‰∏≠...</div></div>
    </div>


    <!-- ===== Menu Dropdown (fixed, two-column) ===== -->
    <div class="menu-dropdown" id="menuDrop">
        <div class="menu-grid" id="menuGrid"></div>
    </div>

    <!-- ===== Print Exit Button ===== -->
    <button class="print-exit-btn" id="printExitBtn" onclick="togglePrint()">‚úï ÁµêÊùüÂàóÂç∞Ê®°Âºè</button>

    <script>
    /* ===== Trip Data Loading ===== */
    var TRIP = null;
    var TRIP_FILE = localStorage.getItem('tripFile') || 'okinawa-trip-2026-Ray.json';

    function loadTrip(filename) {
        TRIP_FILE = filename;
        localStorage.setItem('tripFile', filename);
        fetch(filename + '?t=' + Date.now())
            .then(function(r) { if (!r.ok) throw new Error(r.status); return r.json(); })
            .then(function(data) { TRIP = data; renderTrip(data); })
            .catch(function(e) {
                document.getElementById('tripContent').innerHTML = '<div style="text-align:center;padding:40px;color:#D32F2F;">‚ùå ËºâÂÖ•Â§±ÊïóÔºö' + filename + '<br>' + e.message + '</div>';
            });
    }

    function renderTrip(data) {
        // Update page title
        document.title = data.meta.title;

        // Build nav pills
        var navHtml = '';
        data.days.forEach(function(day) {
            navHtml += '<button class="dn" data-day="' + day.id + '" onclick="scrollToDay(' + day.id + ')">D' + day.id + '</button>';
        });
        document.getElementById('navPills').innerHTML = navHtml;

        // Build sections
        var html = '';

        // Day sections
        data.days.forEach(function(day) {
            html += '<section>';
            html += '<div class="day-header" id="day' + day.id + '"><h2>Day ' + day.id + '</h2><div class="dh-right">' + day.date + '</div></div>';
            html += '<div class="day-content">' + day.content + '</div>';
            html += '</section>';
        });

        // Info sections
        var infoSections = [
            { key: 'flights', id: 'sec-flight' },
            { key: 'checklist', id: 'sec-checklist' },
            { key: 'backup', id: 'sec-backup' },
            { key: 'emergency', id: 'sec-emergency' }
        ];
        infoSections.forEach(function(sec) {
            var d = data[sec.key];
            if (!d) return;
            html += '<section>';
            html += '<div class="day-header info-header" id="' + sec.id + '"><h2>' + d.title + '</h2><button class="dh-menu" onclick="toggleMenu(event)">‚â°</button></div>';
            html += '<div class="day-content">' + d.content + '</div>';
            html += '</section>';
        });

        // Footer
        html += '<footer>';
        html += '<h3>' + data.footer.title + '</h3>';
        html += '<p>' + data.footer.dates + '</p>';
        html += '<p style="font-weight:600;">' + data.footer.budget + '</p>';
        html += '<p style="color:var(--gray);">' + data.footer.exchangeNote + '</p>';
        html += '<p>' + data.footer.tagline + '</p>';
        html += '</footer>';

        document.getElementById('tripContent').innerHTML = html;

        // Build menu
        buildMenu(data);

        // Init ARIA
        initAria();

        // Init weather
        if (data.weather && data.weather.length) initWeather(data.weather);

        // Auto-scroll to today
        autoScrollToday(data.autoScrollDates);

        // Re-init nav scroll tracking
        initNavTracking();
    }

    function buildMenu(data) {
        var html = '<div class="menu-col">';
        data.days.forEach(function(day) {
            html += '<button class="menu-item" onclick="scrollToSec(\'day' + day.id + '\')">üìç D' + day.id + ' ' + day.label + '</button>';
        });
        html += '</div><div class="menu-col">';
        html += '<button class="menu-item" onclick="scrollToSec(\'sec-flight\')">‚úàÔ∏è Ëà™Áè≠Ë≥áË®ä</button>';
        html += '<button class="menu-item" onclick="scrollToSec(\'sec-checklist\')">‚úÖ Âá∫ÁôºÂâçÁ¢∫Ë™ç</button>';
        html += '<button class="menu-item" onclick="scrollToSec(\'sec-backup\')">üîÑ È¢±È¢®/Èõ®Â§©ÂÇôÊ°à</button>';
        html += '<button class="menu-item" onclick="scrollToSec(\'sec-emergency\')">üÜò Á∑äÊÄ•ËÅØÁµ°</button>';
        html += '<div class="menu-sep"></div>';
        html += '<button class="menu-item" onclick="toggleDark()">üåô Ê∑±Ëâ≤Ê®°Âºè</button>';
        html += '<button class="menu-item" onclick="togglePrint()">üñ®Ô∏è ÂàóÂç∞Ê®°Âºè</button>';
        html += '<button class="menu-item" onclick="switchTripFile()">üìÇ ÂàáÊèõË°åÁ®ãÊ™î</button>';
        html += '</div>';
        document.getElementById('menuGrid').innerHTML = html;
        // Update dark mode button text
        if (document.body.classList.contains('dark')) {
            var btn = document.querySelector('.menu-item[onclick*="toggleDark"]');
            if (btn) btn.textContent = '‚òÄÔ∏è Ê∑∫Ëâ≤Ê®°Âºè';
        }
    }

    /* ===== Toggle Functions ===== */
    function toggleEv(e, el) {
        if (e.target.tagName === 'A') return;
        var ev = el.closest('.tl-event');
        ev.classList.toggle('expanded');
        el.setAttribute('aria-expanded', ev.classList.contains('expanded'));
    }
    function toggleCol(el) {
        el.classList.toggle('open');
        var detail = el.nextElementSibling;
        if (detail) detail.classList.toggle('open');
        el.setAttribute('aria-expanded', el.classList.contains('open'));
    }
    function toggleDark() {
        document.getElementById('menuDrop').classList.remove('open'); document.body.style.overflow = '';
        document.body.classList.toggle('dark');
        var isDark = document.body.classList.contains('dark');
        localStorage.setItem('dark', isDark ? '1' : '0');
        var btn = document.querySelector('.menu-item[onclick*="toggleDark"]');
        if (btn) btn.textContent = isDark ? '‚òÄÔ∏è Ê∑∫Ëâ≤Ê®°Âºè' : 'üåô Ê∑±Ëâ≤Ê®°Âºè';
        var meta = document.querySelector('meta[name="theme-color"]');
        if (meta) meta.setAttribute('content', isDark ? '#1565C0' : '#0077B6');
    }
    if (localStorage.getItem('dark') === '1') {
        document.body.classList.add('dark');
        var dmeta = document.querySelector('meta[name="theme-color"]');
        if (dmeta) dmeta.setAttribute('content', '#1565C0');
    }
    function scrollToSec(id) {
        var el = document.getElementById(id);
        if (!el) return;
        var navH = document.getElementById('stickyNav').offsetHeight;
        var top = el.getBoundingClientRect().top + window.pageYOffset - navH;
        window.scrollTo({ top: top, behavior: 'smooth' });
        document.getElementById('menuDrop').classList.remove('open'); document.body.style.overflow = '';
    }
    function scrollToDay(n) { scrollToSec('day' + n); }
    function toggleMenu(e) {
        e.stopPropagation();
        var menu = document.getElementById('menuDrop');
        if (menu.classList.contains('open')) { menu.classList.remove('open'); document.body.style.overflow = ''; return; }
        var rect = e.currentTarget.getBoundingClientRect();
        menu.style.top = (rect.bottom + 4) + 'px';
        menu.style.right = (window.innerWidth - rect.right) + 'px';
        menu.classList.add('open');
        document.body.style.overflow = 'hidden';
    }
    function toggleHw(el) {
        var p = el.closest('.hourly-weather');
        p.classList.toggle('hw-open');
        if (p.classList.contains('hw-open')) {
            var g = p.querySelector('.hw-grid');
            if (g) { var now = new Date().getHours(), tb = g.querySelector('.hw-now') || g.querySelector('[data-hour="' + Math.max(6, Math.min(21, now)) + '"]'); if (tb) g.scrollLeft = tb.offsetLeft - g.offsetLeft; }
        }
    }
    function togglePrint() {
        document.getElementById('menuDrop').classList.remove('open'); document.body.style.overflow = '';
        var entering = !document.body.classList.contains('print-mode');
        if (entering && document.body.classList.contains('dark')) {
            document.body.dataset.wasDark = '1';
            document.body.classList.remove('dark');
            var btn = document.querySelector('.menu-item[onclick*="toggleDark"]');
            if (btn) btn.textContent = 'üåô Ê∑±Ëâ≤Ê®°Âºè';
        }
        document.body.classList.toggle('print-mode');
        if (!entering && document.body.dataset.wasDark === '1') {
            document.body.classList.add('dark');
            delete document.body.dataset.wasDark;
            var btn2 = document.querySelector('.menu-item[onclick*="toggleDark"]');
            if (btn2) btn2.textContent = '‚òÄÔ∏è Ê∑∫Ëâ≤Ê®°Âºè';
        }
    }

    /* ===== Switch Trip File ===== */
    function switchTripFile() {
        document.getElementById('menuDrop').classList.remove('open'); document.body.style.overflow = '';
        var input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = function(e) {
            var file = e.target.files[0];
            if (!file) return;
            var reader = new FileReader();
            reader.onload = function(ev) {
                try {
                    var data = JSON.parse(ev.target.result);
                    TRIP = data;
                    localStorage.setItem('tripFile', file.name);
                    TRIP_FILE = file.name;
                    renderTrip(data);
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } catch(err) {
                    alert('JSON Ê†ºÂºèÈåØË™§Ôºö' + err.message);
                }
            };
            reader.readAsText(file);
        };
        input.click();
    }

    /* ===== ARIA Init ===== */
    function initAria() {
        document.querySelectorAll('.col-row').forEach(function(el) {
            el.setAttribute('role', 'button');
            el.setAttribute('aria-expanded', 'false');
        });
        document.querySelectorAll('.tl-head.clickable').forEach(function(el) {
            el.setAttribute('role', 'button');
            el.setAttribute('aria-expanded', 'false');
        });
    }

    /* ===== Day Nav Active Pill + Sticky Nav Update ===== */
    function initNavTracking() {
        var headers = [];
        if (!TRIP) return;
        for (var i = 1; i <= TRIP.days.length; i++) { var h = document.getElementById('day' + i); if (h) headers.push(h); }
        var navPills = document.querySelectorAll('#stickyNav .dh-nav .dn[data-day]');
        if (!navPills.length) return;
        var navH = document.getElementById('stickyNav').offsetHeight;
        var infoStart = document.getElementById('sec-flight');
        // Remove old listener if any
        if (window._navScrollHandler) window.removeEventListener('scroll', window._navScrollHandler);
        var ticking = false;
        window._navScrollHandler = function() {
            if (!ticking) { requestAnimationFrame(function() {
                var inInfo = infoStart && infoStart.getBoundingClientRect().top <= navH + 10;
                var current = -1;
                if (!inInfo) { for (var i = 0; i < headers.length; i++) { if (headers[i].getBoundingClientRect().top <= navH + 10) current = i; } }
                navPills.forEach(function(btn) { btn.classList.toggle('active', current >= 0 && parseInt(btn.getAttribute('data-day')) === current + 1); });
                ticking = false;
            }); ticking = true; }
        };
        window.addEventListener('scroll', window._navScrollHandler);
    }

    /* ===== Auto-scroll to today ===== */
    function autoScrollToday(dates) {
        if (!dates || !dates.length) return;
        var now = new Date();
        var todayStr = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0') + '-' + String(now.getDate()).padStart(2,'0');
        var idx = dates.indexOf(todayStr);
        if (idx >= 0) {
            var el = document.getElementById('day' + (idx + 1));
            if (el) {
                var navH = document.getElementById('stickyNav').offsetHeight;
                window.scrollTo({ top: el.offsetTop - navH, behavior: 'auto' });
            }
        }
    }

    // Close menu when clicking outside
    document.addEventListener('click', function(e) {
        var menu = document.getElementById('menuDrop');
        if (menu && menu.classList.contains('open') && !e.target.closest('.dh-menu') && !e.target.closest('#menuDrop')) {
            menu.classList.remove('open'); document.body.style.overflow = '';
        }
    });

    /* ===== Hourly Weather API (Open-Meteo) ===== */
    function initWeather(weatherDays) {
        var WMO={0:'‚òÄÔ∏è',1:'üå§Ô∏è',2:'‚õÖ',3:'‚òÅÔ∏è',45:'üå´Ô∏è',48:'üå´Ô∏è',51:'üå¶Ô∏è',53:'üå¶Ô∏è',55:'üåßÔ∏è',56:'üåßÔ∏è',57:'üåßÔ∏è',61:'üå¶Ô∏è',63:'üåßÔ∏è',65:'üåßÔ∏è',66:'üåßÔ∏è',67:'üåßÔ∏è',71:'üå®Ô∏è',73:'üå®Ô∏è',75:'üå®Ô∏è',77:'üå®Ô∏è',80:'üå¶Ô∏è',81:'üåßÔ∏è',82:'üåßÔ∏è',85:'üå®Ô∏è',86:'üå®Ô∏è',95:'‚õàÔ∏è',96:'‚õàÔ∏è',99:'‚õàÔ∏è'};

        function getLocIdx(day,h){for(var i=day.locations.length-1;i>=0;i--)if(h>=day.locations[i].start)return i;return 0;}

        function renderHourly(c,m,day){
            var now=new Date(),ch=now.getHours();
            var minT=99,maxT=-99,minR=100,maxR=0,iconCount={},bestIcon='‚òÄÔ∏è';
            for(var h=0;h<24;h++){var t=Math.round(m.temps[h]),r=m.rains[h],ic=WMO[m.codes[h]]||'‚ùì';if(t<minT)minT=t;if(t>maxT)maxT=t;if(r<minR)minR=r;if(r>maxR)maxR=r;iconCount[ic]=(iconCount[ic]||0)+1;}
            var maxCnt=0;for(var k in iconCount)if(iconCount[k]>maxCnt){maxCnt=iconCount[k];bestIcon=k;}
            var locs=day.locations.map(function(l){return l.name;}).filter(function(v,i,a){return a.indexOf(v)===i;}).join('‚Üí');
            var html='<div class="hw-summary" onclick="toggleHw(this)">'+bestIcon+' '+minT+'~'+maxT+'¬∞C &nbsp;„Éª&nbsp; üíß'+minR+'~'+maxR+'% &nbsp;„Éª&nbsp; '+locs+'<span class="hw-summary-arrow">‚ñ∏</span></div>';
            html+='<div class="hw-detail"><div class="hourly-weather-header"><span class="hourly-weather-title">‚è±Ô∏è ÈÄêÊôÇÂ§©Ê∞£ ‚Äî '+day.label+'</span><span class="hw-update-time">'+ch+':'+String(now.getMinutes()).padStart(2,'0')+'</span></div><div class="hw-grid">';
            for(var h=0;h<=23;h++){
                var li=getLocIdx(day,h),icon=WMO[m.codes[h]]||'‚ùì',temp=Math.round(m.temps[h]),rain=m.rains[h],isNow=(h===ch);
                html+='<div class="hw-block'+(isNow?' hw-now':'')+'" data-hour="'+h+'"><div class="hw-block-time">'+(isNow?'‚ñ∂ ':'')+h+':00</div>';
                if(day.locations.length>1)html+='<div class="hw-block-loc hw-loc-'+li+'">'+day.locations[li].name+'</div>';
                html+='<div class="hw-block-icon">'+icon+'</div><div class="hw-block-temp">'+temp+'¬∞C</div><div class="hw-block-rain'+(rain>=50?' hw-rain-high':'')+'">üíß'+rain+'%</div></div>';
            }
            html+='</div></div>';c.innerHTML=html;
        }

        function fetchDay(day){
            var c=document.getElementById(day.id);if(!c)return;
            var uq=[],seen={};
            day.locations.forEach(function(l){var k=l.lat+','+l.lon;if(!seen[k]){seen[k]=true;uq.push(l);}});
            Promise.all(uq.map(function(l){
                return fetch('https://api.open-meteo.com/v1/forecast?latitude='+l.lat+'&longitude='+l.lon+'&hourly=temperature_2m,precipitation_probability,weather_code&start_date='+day.date+'&end_date='+day.date+'&timezone=Asia/Tokyo').then(function(r){return r.json();}).then(function(d){return{loc:l,data:d};});
            })).then(function(res){
                var dm={};res.forEach(function(r){dm[r.loc.lat+','+r.loc.lon]=r.data;});
                var mg={temps:[],rains:[],codes:[]};
                for(var h=0;h<24;h++){var li=getLocIdx(day,h),l=day.locations[li],d=dm[l.lat+','+l.lon];
                    if(d&&d.hourly){mg.temps.push(d.hourly.temperature_2m[h]);mg.rains.push(d.hourly.precipitation_probability[h]);mg.codes.push(d.hourly.weather_code[h]);}
                    else{mg.temps.push(0);mg.rains.push(0);mg.codes.push(0);}
                }
                renderHourly(c,mg,day);
            }).catch(function(e){c.innerHTML='<div class="hw-error">Â§©Ê∞£Ë≥áÊñôËºâÂÖ•Â§±ÊïóÔºö'+e.message+'</div>';});
        }
        weatherDays.forEach(fetchDay);
    }

    window.addEventListener('beforeprint',function(){document.body.classList.add('print-mode');});
    window.addEventListener('afterprint',function(){document.body.classList.remove('print-mode');});

    // Initial load
    loadTrip(TRIP_FILE);
    </script>
</body>
</html>
